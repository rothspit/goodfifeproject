# 出勤スケジュール取り込みシステム - 実装完了ガイド

## 📋 概要

CSVファイルからキャストの出勤スケジュールを一括インポートするシステムを実装しました。
複数のキャストの複数日分のスケジュールを一度に登録・更新できます。

---

## ✅ 実装内容

### 機能
- ✅ CSVファイルのアップロードと解析
- ✅ 複数キャストの一括スケジュール登録
- ✅ 既存スケジュールの自動更新
- ✅ プレビュー機能
- ✅ エラーハンドリング
- ✅ 時間形式の自動パース

### 対応している時間形式
1. **通常の時間帯**: `16:00～23:00`
2. **翌日までの時間帯**: `16:00～翌06:00`
3. **時間未定（出勤のみ）**: `出勤` → 09:00～23:00として登録
4. **休み**: `休み` または 空欄 → スキップ

---

## 📊 CSVファイルのフォーマット

### 基本構造

```csv
"女の子の名前","2025年12月16(火)","2025年12月17(水)","2025年12月18(木)",...
"風花（ふうか）","16:00～翌06:00","16:00～翌06:00","16:00～翌06:00",...
"希美（のぞみ）","16:00～翌06:00","","",... 
"香也（かや）","休み","14:00～21:00","14:00～16:00",...
```

### フォーマット詳細

#### 1行目（ヘッダー）
- **1列目**: `"女の子の名前"`（固定）
- **2列目以降**: 日付（`"YYYY年MM月DD(曜)"` 形式）
  - 例: `"2025年12月16(火)"`

#### 2行目以降（データ）
- **1列目**: キャスト名
  - 括弧内のひらがなは自動削除されます
  - 例: `"風花（ふうか）"` → `"風花"`
- **2列目以降**: 各日付の時間帯
  - 時間形式: 上記「対応している時間形式」参照
  - 空欄または`休み`の場合はスキップ

---

## 🚀 使い方

### 1. CSVファイルを準備

#### オプション1: 提供されたCSVファイルをそのまま使用
アップロードいただいた `2025-12-16_2025-12-31.csv` の形式がそのまま使用できます。

#### オプション2: Excelで作成してCSV保存
1. Excelで表を作成
2. 1行目: ヘッダー（女の子の名前、日付...）
3. 2行目以降: キャスト名と時間帯
4. 「名前を付けて保存」→「CSV UTF-8（カンマ区切り）」

### 2. 管理画面でインポート

#### ステップ1: 管理画面にログイン
- URL: https://crm.h-mitsu.com/admin
- ログイン情報を入力

#### ステップ2: スケジュール取り込みページを開く
- 左メニューから「スケジュール取り込み」をクリック

#### ステップ3: CSVファイルを選択
- 「ファイルを選択」ボタンからCSVファイルを選択
- ファイル名とサイズが表示されます

#### ステップ4: CSVを解析
- 「CSVファイルを解析」ボタンをクリック
- プレビューでデータを確認

#### ステップ5: インポート実行
- 内容を確認したら「データベースにインポート」ボタンをクリック
- 確認ダイアログで「OK」をクリック

#### ステップ6: 完了
- インポート完了のメッセージが表示されます
- 既存スケジュールは自動的に更新されます

---

## 🔧 技術詳細

### バックエンド実装

#### ファイル構成
```
server/
├── src/
│   ├── controllers/
│   │   └── scheduleImportController.ts  # メインロジック
│   └── routes/
│       └── scheduleImport.ts            # ルート定義
```

#### APIエンドポイント

##### 1. CSVアップロード
```http
POST /api/schedule-import/upload
Content-Type: multipart/form-data
Authorization: Bearer {token}

FormData:
  csv: (CSV file)

Response:
{
  "success": true,
  "data": [
    {
      "castName": "風花",
      "schedules": {
        "2025-12-16": "16:00～翌06:00",
        "2025-12-17": "16:00～翌06:00",
        ...
      }
    },
    ...
  ],
  "count": 19
}
```

##### 2. スケジュールインポート
```http
POST /api/schedule-import/import
Content-Type: application/json
Authorization: Bearer {token}

Body:
{
  "schedules": [
    {
      "castName": "風花",
      "schedules": {
        "2025-12-16": "16:00～翌06:00",
        "2025-12-17": "16:00～翌06:00"
      }
    }
  ]
}

Response:
{
  "success": true,
  "message": "95件のスケジュールをインポートしました",
  "imported": 95,
  "skipped": 0,
  "errors": []
}
```

##### 3. 期間指定スケジュール取得
```http
GET /api/schedule-import/range?startDate=2025-12-16&endDate=2025-12-31
Authorization: Bearer {token}

Response:
{
  "success": true,
  "schedules": [
    {
      "id": 1,
      "cast_id": 5,
      "date": "2025-12-16",
      "start_time": "16:00",
      "end_time": "06:00",
      "is_available": 1,
      "cast_name": "風花",
      "name_hiragana": "ふうか"
    },
    ...
  ],
  "count": 95
}
```

### データベース更新ロジック

#### 既存スケジュールの処理
```sql
-- キャストIDと日付でスケジュールを検索
SELECT id FROM cast_schedules 
WHERE cast_id = ? AND date = ?

-- 既存の場合: UPDATE
UPDATE cast_schedules 
SET start_time = ?, end_time = ?, is_available = 1 
WHERE cast_id = ? AND date = ?

-- 新規の場合: INSERT
INSERT INTO cast_schedules 
(cast_id, date, start_time, end_time, is_available)
VALUES (?, ?, ?, ?, 1)
```

### 時間パース処理

#### 実装例
```typescript
function parseTimeRange(timeStr: string) {
  // "16:00～翌06:00" 形式
  const nextDayMatch = timeStr.match(/(\d{1,2}:\d{2})～翌(\d{1,2}:\d{2})/);
  if (nextDayMatch) {
    return {
      start: nextDayMatch[1],  // "16:00"
      end: nextDayMatch[2],    // "06:00"
      nextDay: true
    };
  }
  
  // "16:00～23:00" 形式
  const sameDayMatch = timeStr.match(/(\d{1,2}:\d{2})～(\d{1,2}:\d{2})/);
  if (sameDayMatch) {
    return {
      start: sameDayMatch[1],  // "16:00"
      end: sameDayMatch[2],    // "23:00"
      nextDay: false
    };
  }
  
  // "出勤"のみ
  if (timeStr === '出勤') {
    return {
      start: '09:00',
      end: '23:00',
      nextDay: false
    };
  }
  
  return null;  // 休み or 空欄
}
```

---

## 📝 CSVサンプル

### サンプル1: 基本的なスケジュール
```csv
"女の子の名前","2025年12月16(火)","2025年12月17(水)","2025年12月18(木)"
"風花（ふうか）","16:00～翌06:00","16:00～翌06:00","16:00～翌06:00"
"希美（のぞみ）","16:00～翌06:00","","" 
"香也（かや）","休み","14:00～21:00","14:00～16:00"
```

### サンプル2: 複雑なパターン
```csv
"女の子の名前","2025年12月16(火)","2025年12月17(水)","2025年12月18(木)"
"美海（みう）","10:00～18:30","休み","10:00～18:00"
"美穂（みほ）","21:00～翌06:00","13:00～翌06:00","出勤"
"唯（ゆい）","休み","休み","18:00～翌03:00"
```

---

## 🐛 トラブルシューティング

### エラー: "CSVの解析に失敗しました"

**原因1**: ファイル形式が正しくない
→ CSV UTF-8形式で保存されているか確認

**原因2**: ヘッダー行の形式が違う
→ 1列目が「女の子の名前」になっているか確認

**原因3**: 日付形式が違う
→ 日付列が「YYYY年MM月DD(曜)」形式になっているか確認

### エラー: "キャストが見つかりません"

**原因**: データベースに登録されていないキャスト名
→ キャスト管理画面で事前に登録してください
→ 括弧内のひらがなは自動削除されるので「風花」「ふうか」どちらでもOK

### 一部のスケジュールがスキップされる

**原因1**: 時間形式が認識できない
→ 対応している時間形式を使用してください

**原因2**: キャスト名が一致しない
→ データベースのキャスト名と完全一致する必要があります

### 既存スケジュールが消えてしまう

**仕様**: CSVに含まれない日付のスケジュールは削除されません
→ 既存スケジュールは維持され、CSVの日付のみ更新されます

---

## 💡 活用例

### 週次スケジュール更新
1. 毎週月曜日に翌週のスケジュールCSVを準備
2. 管理画面からインポート
3. 既存の同じ日付のスケジュールは自動更新

### 月次スケジュール一括登録
1. 月初に全キャストの1ヶ月分のスケジュールを作成
2. 一括インポート
3. 変更があれば再度CSVを修正してインポート

### 複数店舗の管理
1. 店舗ごとにCSVファイルを作成
2. それぞれの店舗のキャストのみ記載
3. 順番にインポート

---

## 📋 チェックリスト

インポート前に確認:

- [ ] CSVファイルを準備した
- [ ] ヘッダー行（1行目）が正しい形式になっている
- [ ] 日付列が「YYYY年MM月DD(曜)」形式
- [ ] キャスト名がデータベースに登録済み
- [ ] 時間帯が対応している形式で記載されている
- [ ] ファイル文字コードがUTF-8またはShift-JIS
- [ ] 管理画面にログイン済み

---

## 🔐 セキュリティ

### 認証
- すべてのAPIエンドポイントは認証が必要
- 管理者権限でのみアクセス可能

### ファイル処理
- アップロードファイルは一時ディレクトリに保存
- 処理完了後に自動削除
- multerでファイルタイプとサイズを制限

### データ検証
- キャスト存在チェック
- 日付形式の検証
- トランザクション処理でデータ整合性を保証

---

## 🎓 応用機能（今後の拡張）

### 実装可能な追加機能

#### 1. スケジュールテンプレート
- よく使うパターンをテンプレート化
- ワンクリックで適用

#### 2. 一括削除
- 特定期間のスケジュールを一括削除
- キャストごとの削除

#### 3. スケジュール出力
- 現在のスケジュールをCSVでエクスポート
- 編集して再インポート

#### 4. 空き状況確認
- 日時指定で空いているキャストを検索
- 予約可能なキャストの一覧表示

---

## 📞 サポート

問題が発生した場合:

### 1. ブラウザコンソール確認
```
F12キーを押して開発者ツールを開く
Consoleタブでエラーメッセージを確認
```

### 2. サーバーログ確認
```bash
ssh root@210.131.222.152
pm2 logs goodfife-backend --lines 50
```

### 3. データベース確認
```bash
mysql -u root -p goodfife_db
SELECT * FROM cast_schedules 
WHERE date BETWEEN '2025-12-16' AND '2025-12-31'
ORDER BY date, cast_id;
```

### 4. CSVファイル確認
- 文字コードを確認（UTF-8推奨）
- 改行コードを確認（LFまたはCRLF）
- ダブルクォーテーションの有無を確認

---

## 🎉 まとめ

### ✅ 実装完了
- CSVファイルからの一括インポート
- 複数キャスト、複数日分を一度に処理
- 既存スケジュールの自動更新
- エラーハンドリングと詳細レポート

### 🚀 次のステップ
1. 必要なnpmパッケージをインストール（csv-parser, multer）
2. サーバーにデプロイ
3. テストCSVファイルでインポートテスト
4. 本番データで運用開始

### 📝 必要なパッケージ
```bash
# サーバーで実行
cd /var/www/goodfifeproject/server
npm install csv-parser multer
npm install --save-dev @types/multer
```

---

**実装日**: 2025-12-16  
**バージョン**: 1.0.0  
**ステータス**: ✅ 実装完了（デプロイ待ち）
