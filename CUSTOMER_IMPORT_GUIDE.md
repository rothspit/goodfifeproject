# 顧客CSV一括取り込み機能 完全ガイド

**作成日**: 2025-12-15  
**バージョン**: 1.0

---

## 🎯 概要

既存の顧客データをCSVファイルから一括でインポートし、電話番号をキーとして自動的にデータを結合する機能です。

### 主な機能

1. **CSVファイル一括インポート**
   - 複数の顧客データを一度に登録
   - ExcelやGoogleスプレッドシートから直接保存可能

2. **電話番号での自動結合** ✨
   - 同じ電話番号の顧客データを自動検出
   - 既存データと新規データを自動マージ
   - 重複を防ぎながらデータ更新

3. **電話番号検索**
   - 電話番号を入力すれば即座に顧客情報表示
   - 受注履歴も同時表示

4. **データプレビュー**
   - インポート前に内容を確認
   - 新規/既存の判定を視覚的に表示

---

## 📋 CSVフォーマット

### 必須項目
- **電話番号**: 必須（これをキーに結合判定）

### 推奨項目
- 顧客名
- メールアドレス
- 住所
- 生年月日
- 顧客タイプ（new/regular/vip）
- 交通費
- 備考

### CSVサンプル

```csv
電話番号,顧客名,メールアドレス,住所,生年月日,顧客タイプ,交通費,備考
090-1234-5678,山田太郎,yamada@example.com,東京都渋谷区,1985-01-15,regular,2000,VIP顧客
080-9876-5432,佐藤花子,sato@example.com,千葉県船橋市,1990-05-20,new,0,
03-1234-5678,鈴木一郎,suzuki@example.com,東京都新宿区,1980-03-10,vip,3000,役員顧客
```

### 電話番号の形式

以下の形式すべてに対応しています：
- ハイフンあり: `090-1234-5678`
- ハイフンなし: `09012345678`
- +81形式: `+81-90-1234-5678`
- スペースあり: `090 1234 5678`
- 固定電話: `03-1234-5678`

→ すべて自動的に正規化されます

---

## 🚀 使い方

### Step 1: CSVテンプレートをダウンロード

1. 管理画面 → **顧客CSV一括取り込み**
2. 「📥 CSVテンプレートをダウンロード」をクリック
3. ダウンロードしたファイルを開く

### Step 2: データを入力

#### Excelの場合
1. テンプレートをExcelで開く
2. データを入力
3. 「名前を付けて保存」→ **CSV UTF-8 (コンマ区切り)** で保存

#### Googleスプレッドシートの場合
1. テンプレートをGoogleスプレッドシートにアップロード
2. データを入力
3. 「ファイル」→「ダウンロード」→ **カンマ区切り形式 (.csv)** を選択

### Step 3: CSVファイルをアップロード

1. 「CSVファイルを選択」でファイルを選ぶ
2. 「CSVファイルを解析」をクリック
3. 解析結果が表示される

### Step 4: データプレビューを確認

解析が完了すると、以下の情報が表示されます：

#### 統計情報
```
📊 解析結果
合計: 50件
新規: 35件
既存（更新）: 15件
```

#### データテーブル
| アクション | 電話番号 | 顧客名 | メール | 既存情報 |
|----------|---------|--------|-------|---------|
| 新規登録 | 090-1234-5678 | 山田太郎 | ... | - |
| 更新 | 080-9876-5432 | 佐藤花子 | ... | 既存: 佐藤花子<br>受注3件 |

- **緑色（新規登録）**: 新しく追加される顧客
- **オレンジ色（更新）**: 既存顧客のデータが更新される

### Step 5: インポート実行

1. データを確認
2. 「○○件のデータをインポート」ボタンをクリック
3. 確認ダイアログで「OK」
4. インポート完了！

---

## 🔍 電話番号検索機能

### 使い方

1. **電話番号検索セクション**に電話番号を入力
2. 「検索」ボタンをクリック
3. 顧客情報と受注履歴が即座に表示

### 表示される情報

#### 顧客基本情報
- 顧客名
- 電話番号
- メールアドレス
- 顧客タイプ
- 総受注数
- 最終来店日

#### 受注履歴（最新10件）
- 営業日
- 担当キャスト
- 店舗
- 金額

---

## ⚙️ 自動結合ロジック

### 電話番号の正規化

すべての電話番号は以下のルールで正規化されます：

```
入力: 090-1234-5678
      ↓
正規化: 09012345678

入力: +81-90-1234-5678
      ↓
正規化: 09012345678

入力: 81-90-1234-5678
      ↓
正規化: 09012345678
```

### 重複判定

1. CSVの電話番号を正規化
2. データベースの既存電話番号と照合
3. 一致した場合 → **既存顧客として更新**
4. 一致しない場合 → **新規顧客として登録**

### 更新されるデータ

既存顧客の場合、以下のデータが更新されます：
- ✅ 顧客名（上書き）
- ✅ メールアドレス（上書き）
- ✅ 住所（上書き）
- ✅ 備考（上書き）
- ✅ 顧客タイプ（上書き）
- ✅ 交通費（上書き）
- ❌ 受注履歴（保持）
- ❌ 最終来店日（保持）

---

## 📊 APIエンドポイント

### 1. CSVテンプレートダウンロード
```
GET /api/customer-import/template
```

### 2. CSVアップロード＆解析
```
POST /api/customer-import/upload-csv
Content-Type: multipart/form-data

FormData:
  file: (CSV file)
```

**レスポンス**:
```json
{
  "success": true,
  "message": "CSVファイルを解析しました",
  "customers": [...],
  "stats": {
    "total": 50,
    "new": 35,
    "existing": 15
  }
}
```

### 3. 一括インポート
```
POST /api/customer-import/import
Content-Type: application/json

{
  "customers": [...]
}
```

**レスポンス**:
```json
{
  "success": true,
  "message": "顧客データをインポートしました（新規35件、更新15件）",
  "results": {
    "total": 50,
    "created": 35,
    "updated": 15,
    "failed": 0,
    "errors": []
  }
}
```

### 4. 電話番号検索
```
GET /api/customer-import/search?phone=090-1234-5678
```

**レスポンス**:
```json
{
  "success": true,
  "found": true,
  "customer": {
    "id": 1,
    "phone_number": "09012345678",
    "name": "山田太郎",
    "email": "yamada@example.com",
    "total_orders": 5,
    "last_visit_date": "2025-12-10",
    "order_history": [...]
  }
}
```

---

## 🛠️ トラブルシューティング

### Q1: CSVファイルが文字化けする

**原因**: エンコーディングが UTF-8 でない

**解決方法**:
- **Excel**: 「名前を付けて保存」→ **CSV UTF-8 (コンマ区切り)** を選択
- **Googleスプレッドシート**: 「カンマ区切り形式 (.csv)」は自動的にUTF-8

### Q2: 電話番号が認識されない

**原因**: CSVの列名が異なる

**対応している列名**:
- `電話番号`
- `phone`
- `tel`
- `電話`

いずれかを使用してください。

### Q3: 既存顧客が重複してしまう

**原因**: 電話番号の形式が異なる

**解決方法**:
電話番号の正規化機能が自動的に動作します。
以下はすべて同じ番号として認識されます：
- `090-1234-5678`
- `09012345678`
- `+81-90-1234-5678`

### Q4: インポートが失敗する

**確認事項**:
1. 電話番号が空白でないか
2. CSVのフォーマットが正しいか
3. 特殊文字（絵文字など）が含まれていないか

**エラーログの確認**:
インポート結果に `errors` 配列が含まれます。
詳細なエラー情報を確認してください。

---

## 🔐 セキュリティ

### データ保護
- パスワードはデフォルト値（`customer123`）で登録
- 個人情報は暗号化された通信で送信
- CSV一時ファイルは処理後即座に削除

### アクセス制御
- 管理者権限が必要
- 認証トークンによるAPIアクセス制限

---

## 📈 実装詳細

### バックエンド

#### ファイル構成
```
server/src/
├── controllers/
│   └── customerImportController.ts    # メインコントローラー
├── routes/
│   └── customerImport.ts              # ルート定義
└── index.ts                            # ルート登録
```

#### 主要関数

**normalizePhoneNumber(phone: string)**
- 電話番号の正規化
- ハイフン、スペース、括弧を除去
- +81形式を0形式に変換

**parseCustomerCSV(req, res)**
- CSVファイルをパース
- 既存顧客との照合
- 新規/既存の判定

**importCustomers(req, res)**
- トランザクション処理
- 新規顧客登録
- 既存顧客更新

**searchCustomerByPhone(req, res)**
- 電話番号で顧客検索
- 受注履歴取得

### フロントエンド

#### ファイル構成
```
client/app/admin/
└── customer-import/
    └── page.tsx    # メインUI
```

#### 主要コンポーネント

**ファイルアップロード**
- drag & drop対応
- CSV形式検証

**データプレビュー**
- テーブル表示
- 新規/既存の色分け
- 統計情報表示

**電話番号検索**
- リアルタイム検索
- 受注履歴表示

---

## 🎁 今後の拡張予定

### Phase 1 (完了)
- ✅ CSV一括インポート
- ✅ 電話番号自動結合
- ✅ 電話番号検索
- ✅ データプレビュー

### Phase 2 (予定)
- ⏳ Google Sheets API連携
- ⏳ 自動定期インポート
- ⏳ 顧客データエクスポート
- ⏳ 重複候補の手動マージ機能

### Phase 3 (検討中)
- 💭 AIによる顧客情報の補完
- 💭 顧客セグメント自動分類
- 💭 マーケティング自動化連携

---

## 📞 サポート

### ドキュメント
- 本ガイド: `/home/user/webapp/CUSTOMER_IMPORT_GUIDE.md`
- API仕様: 各コントローラーファイル内のコメント

### コード参照
- バックエンド: `/server/src/controllers/customerImportController.ts`
- フロントエンド: `/client/app/admin/customer-import/page.tsx`
- ルート: `/server/src/routes/customerImport.ts`

---

**最終更新**: 2025-12-15  
**作成者**: GenSpark AI Developer  
**バージョン**: 1.0
