# SaaS Phase 2: æ—¢å­˜API ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆç§»è¡Œ - é€²æ—ãƒ¬ãƒãƒ¼ãƒˆ

**æœ€çµ‚æ›´æ–°**: 2025-12-16  
**é€²æ—çŠ¶æ³**: 30% å®Œäº† (3/10)

---

## ğŸ“Š å…¨ä½“é€²æ—

```
å®Œäº†: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“ 30% (3/10)
```

### âœ… å®Œäº†ã—ãŸAPI (3/10)

| No | APIå | ãƒ•ã‚¡ã‚¤ãƒ« | å®Œäº†æ—¥æ™‚ | ã‚³ãƒŸãƒƒãƒˆ |
|----|------|---------|---------|---------|
| 1 | é¡§å®¢ã‚¤ãƒ³ãƒãƒ¼ãƒˆAPI | `customerImportController.ts` | 2025-12-16 | `feat(saas): é¡§å®¢ã‚¤ãƒ³ãƒãƒ¼ãƒˆAPIãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå¯¾å¿œ` |
| 2 | ã‚­ãƒ£ã‚¹ãƒˆã‚¤ãƒ³ãƒãƒ¼ãƒˆAPI | `castImportController.ts` | 2025-12-16 | `feat(saas): ã‚­ãƒ£ã‚¹ãƒˆã‚¤ãƒ³ãƒãƒ¼ãƒˆAPIãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå¯¾å¿œ` |
| 3 | å—æ³¨ã‚¤ãƒ³ãƒãƒ¼ãƒˆAPI | `orderImportController.ts` | 2025-12-16 | `feat(saas): å—æ³¨ã‚¤ãƒ³ãƒãƒ¼ãƒˆAPIãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå¯¾å¿œ` |

---

## ğŸš§ æ®‹ã‚Šã®ã‚¿ã‚¹ã‚¯ (7/10)

### å„ªå…ˆåº¦: é«˜ (ã‚³ã‚¢ãƒ“ã‚¸ãƒã‚¹æ©Ÿèƒ½)

#### 4. èªè¨¼ã‚·ã‚¹ãƒ†ãƒ  (authController.ts)
- **è¡Œæ•°**: ç´„6,000è¡Œ
- **é‡è¦åº¦**: â˜…â˜…â˜…â˜…â˜…
- **æ¦‚è¦**: ãƒ­ã‚°ã‚¤ãƒ³ã€JWT ãƒˆãƒ¼ã‚¯ãƒ³ã«ãƒ†ãƒŠãƒ³ãƒˆæƒ…å ±ã‚’å«ã‚ã‚‹
- **å½±éŸ¿ç¯„å›²**: å…¨API ã®èªè¨¼åŸºç›¤
- **å¿…è¦ãªå¤‰æ›´**:
  - JWT ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã« `company_id`, `store_id` è¿½åŠ 
  - ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ†ãƒŠãƒ³ãƒˆæƒ…å ±ã‚’å–å¾—
  - ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼æ™‚ã«ãƒ†ãƒŠãƒ³ãƒˆæƒ…å ±ã‚’æŠ½å‡º

#### 5. é¡§å®¢ç®¡ç†API (customerController.ts)
- **è¡Œæ•°**: ç´„3,000è¡Œ
- **é‡è¦åº¦**: â˜…â˜…â˜…â˜…â˜…
- **æ¦‚è¦**: é¡§å®¢CRUDã€æ¤œç´¢ã€å±¥æ­´
- **å¿…è¦ãªå¤‰æ›´**:
  - å…¨ã¦ã®é¡§å®¢ã‚¯ã‚¨ãƒªã« `company_id`, `store_id` ãƒ•ã‚£ãƒ«ã‚¿
  - é¡§å®¢ç™»éŒ²æ™‚ã«ãƒ†ãƒŠãƒ³ãƒˆæƒ…å ±ã‚’è‡ªå‹•è¨­å®š

#### 6. å—æ³¨ç®¡ç†API (orderController.ts)
- **è¡Œæ•°**: ç´„13,000è¡Œ
- **é‡è¦åº¦**: â˜…â˜…â˜…â˜…â˜…
- **æ¦‚è¦**: å—æ³¨CRUDã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†
- **å¿…è¦ãªå¤‰æ›´**:
  - å…¨ã¦ã®å—æ³¨ã‚¯ã‚¨ãƒªã«ãƒ†ãƒŠãƒ³ãƒˆãƒ•ã‚£ãƒ«ã‚¿
  - å—æ³¨ä½œæˆæ™‚ã«ãƒ†ãƒŠãƒ³ãƒˆæƒ…å ±ã‚’è‡ªå‹•è¨­å®š

#### 7. ã‚­ãƒ£ã‚¹ãƒˆç®¡ç†API (castController.ts)
- **è¡Œæ•°**: ç´„8,000è¡Œ
- **é‡è¦åº¦**: â˜…â˜…â˜…â˜…â˜†
- **æ¦‚è¦**: ã‚­ãƒ£ã‚¹ãƒˆãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
- **å¿…è¦ãªå¤‰æ›´**:
  - ã‚­ãƒ£ã‚¹ãƒˆæƒ…å ±ã®å–å¾—ãƒ»æ›´æ–°ã«ãƒ†ãƒŠãƒ³ãƒˆãƒ•ã‚£ãƒ«ã‚¿
  - ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®ãƒ†ãƒŠãƒ³ãƒˆåˆ†é›¢

### å„ªå…ˆåº¦: ä¸­ (è£œåŠ©æ©Ÿèƒ½)

#### 8. CTI/Dialpadé€£æºAPI (ctiController.ts, dialpadWebhookController.ts)
- **è¡Œæ•°**: ç´„2,500è¡Œ
- **é‡è¦åº¦**: â˜…â˜…â˜…â˜†â˜†
- **æ¦‚è¦**: é›»è©±é€£æºã€é¡§å®¢ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—
- **å¿…è¦ãªå¤‰æ›´**:
  - Webhookå—ä¿¡æ™‚ã«ãƒ†ãƒŠãƒ³ãƒˆç‰¹å®š
  - é›»è©±ç•ªå·æ¤œç´¢ã«ãƒ†ãƒŠãƒ³ãƒˆãƒ•ã‚£ãƒ«ã‚¿

#### 9. ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»ãƒ–ãƒ­ã‚°API (reviewController.ts, blogController.ts)
- **è¡Œæ•°**: ç´„2,000è¡Œ
- **é‡è¦åº¦**: â˜…â˜…â˜†â˜†â˜†
- **æ¦‚è¦**: ãƒ¬ãƒ“ãƒ¥ãƒ¼æŠ•ç¨¿ã€ãƒ–ãƒ­ã‚°ç®¡ç†
- **å¿…è¦ãªå¤‰æ›´**:
  - ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»ãƒ–ãƒ­ã‚°ã®ä½œæˆãƒ»å–å¾—ã«ãƒ†ãƒŠãƒ³ãƒˆãƒ•ã‚£ãƒ«ã‚¿

#### 10. ãã®ä»–API (ãƒãƒ£ãƒƒãƒˆã€ãƒã‚¤ãƒ³ãƒˆã€ãƒ¬ã‚·ãƒ¼ãƒˆç­‰)
- **è¡Œæ•°**: ç´„3,000è¡Œ
- **é‡è¦åº¦**: â˜…â˜†â˜†â˜†â˜†
- **æ¦‚è¦**: å„ç¨®è£œåŠ©æ©Ÿèƒ½
- **å¿…è¦ãªå¤‰æ›´**:
  - å„æ©Ÿèƒ½ã«ãƒ†ãƒŠãƒ³ãƒˆãƒ•ã‚£ãƒ«ã‚¿ã‚’è¿½åŠ 

---

## ğŸ”„ æ¨™æº–å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³

### 1. Controller ã®å¤‰æ›´

```typescript
// Before
import { Request, Response } from 'express';
export const someFunction = async (req: Request, res: Response) => {
  const data = await db.all('SELECT * FROM table WHERE id = ?', [id]);
}

// After
import { Request, Response } from 'express';
import { TenantRequest } from '../middleware/tenantAuth';

export const someFunction = async (req: TenantRequest, res: Response) => {
  const { companyId, storeId } = req.tenant || {};
  
  if (!companyId || !storeId) {
    return res.status(403).json({ error: 'ãƒ†ãƒŠãƒ³ãƒˆæƒ…å ±ãŒå¿…è¦ã§ã™' });
  }
  
  const data = await db.all(
    'SELECT * FROM table WHERE id = ? AND company_id = ? AND store_id = ?',
    [id, companyId, storeId]
  );
}
```

### 2. Route ã®å¤‰æ›´

```typescript
// Before
import { authMiddleware } from '../middleware/auth';
router.get('/some-endpoint', authMiddleware, someController);

// After
import { verifyToken, extractTenantInfo, requireStaff } from '../middleware/tenantAuth';
router.get('/some-endpoint', verifyToken, extractTenantInfo, requireStaff, someController);
```

### 3. SQL ã‚¯ã‚¨ãƒªã®å¤‰æ›´

```sql
-- SELECT ã«è¿½åŠ 
WHERE ... AND company_id = ? AND store_id = ?

-- INSERT ã«è¿½åŠ 
INSERT INTO table (..., company_id, store_id)
VALUES (..., ?, ?)

-- UPDATE ã«è¿½åŠ 
UPDATE table SET ...
WHERE id = ? AND company_id = ? AND store_id = ?
```

---

## ğŸ“ˆ å®Ÿè£…çµ±è¨ˆ

### å®Œäº†æ¸ˆã¿ (3 API)

- **å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°**: 6 ãƒ•ã‚¡ã‚¤ãƒ«
- **è¿½åŠ è¡Œæ•°**: ç´„ 127 è¡Œ
- **å¤‰æ›´è¡Œæ•°**: ç´„ 64 è¡Œ
- **å‰Šé™¤è¡Œæ•°**: ç´„ 0 è¡Œ
- **å®Ÿè£…æ™‚é–“**: ç´„ 40 åˆ†

### äºˆæ¸¬

- **æ®‹ã‚Š API æ•°**: 7 å€‹
- **æ¨å®šå¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°**: ç´„ 14-20 ãƒ•ã‚¡ã‚¤ãƒ«
- **æ¨å®šè¿½åŠ è¡Œæ•°**: ç´„ 300-400 è¡Œ
- **æ¨å®šå®Ÿè£…æ™‚é–“**: ç´„ 3-3.5 æ™‚é–“

---

## ğŸ¯ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

### æ¨å¥¨é †åº

1. **èªè¨¼ã‚·ã‚¹ãƒ†ãƒ  (authController.ts)** - æœ€é‡è¦ã€ä»–ã®å…¨APIã«å½±éŸ¿
2. **é¡§å®¢ç®¡ç†API (customerController.ts)** - ã‚³ã‚¢ãƒ“ã‚¸ãƒã‚¹æ©Ÿèƒ½
3. **å—æ³¨ç®¡ç†API (orderController.ts)** - ã‚³ã‚¢ãƒ“ã‚¸ãƒã‚¹æ©Ÿèƒ½
4. **ã‚­ãƒ£ã‚¹ãƒˆç®¡ç†API (castController.ts)** - é‡è¦æ©Ÿèƒ½
5. **CTI/Dialpadé€£æºAPI** - é›»è©±é€£æº
6. **ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»ãƒ–ãƒ­ã‚°API** - è£œåŠ©æ©Ÿèƒ½
7. **ãã®ä»–API** - æ®‹ã‚Šã®æ©Ÿèƒ½

---

## âœ… å“è³ªãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

å„APIã®å®Ÿè£…å¾Œã€ä»¥ä¸‹ã‚’ç¢ºèª:

- [ ] `TenantRequest` å‹ã‚’ä½¿ç”¨
- [ ] `company_id`, `store_id` ã®å­˜åœ¨ç¢ºèª
- [ ] SELECT ã‚¯ã‚¨ãƒªã«ãƒ†ãƒŠãƒ³ãƒˆãƒ•ã‚£ãƒ«ã‚¿è¿½åŠ 
- [ ] INSERT ã‚¯ã‚¨ãƒªã«ãƒ†ãƒŠãƒ³ãƒˆæƒ…å ±è¿½åŠ 
- [ ] UPDATE ã‚¯ã‚¨ãƒªã«ãƒ†ãƒŠãƒ³ãƒˆæ¡ä»¶è¿½åŠ 
- [ ] DELETE ã‚¯ã‚¨ãƒªã«ãƒ†ãƒŠãƒ³ãƒˆæ¡ä»¶è¿½åŠ 
- [ ] Routes ã« `verifyToken, extractTenantInfo, requireStaff` è¿½åŠ 
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã§ãƒ†ãƒŠãƒ³ãƒˆä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯
- [ ] Git ã‚³ãƒŸãƒƒãƒˆæ¸ˆã¿
- [ ] ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«é€²æ—ç•ªå·è¨˜è¼‰ (ä¾‹: Phase2 3/10)

---

## ğŸ“š å‚è€ƒè³‡æ–™

- [SaaS ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå®Ÿè£…ã‚¬ã‚¤ãƒ‰](./SAAS_MULTITENANT_IMPLEMENTATION.md)
- [Phase 1 å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ](./SAAS_MULTITENANT_IMPLEMENTATION.md)
- [ãƒ†ãƒŠãƒ³ãƒˆèªè¨¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢](./server/src/middleware/tenantAuth.ts)
- [DB ã‚¹ã‚­ãƒ¼ãƒç§»è¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆ](./server/migrations/saas_multitenant_schema.sql)

---

**é€²æ—çŠ¶æ³**: ğŸš€ é †èª¿  
**äºˆå®šå®Œäº†æ—¥**: 2025-12-16 (æœ¬æ—¥ä¸­)  
**æ¬¡å›æ›´æ–°**: æ¬¡ã®APIå®Œäº†å¾Œ
