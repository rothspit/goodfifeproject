# 顧客Excelインポート機能 完全ガイド

## 📊 概要

複雑なExcelファイル（受注シートなど）から顧客情報を柔軟に取り込むための高度なインポート機能です。

### ✨ 主な特徴

1. **シート選択UI** - 複数シートから任意のシートを選択
2. **カラムマッピング** - 列を自由に指定（どの列が何の情報か指定可能）
3. **行範囲指定** - データの開始行・終了行を指定
4. **リアルタイムプレビュー** - インポート前にデータを確認
5. **電話番号自動結合** - 既存顧客との重複を自動検出・統合
6. **4ステップのシンプルフロー**

---

## 🚀 使い方

### Step 1: Excelファイルをアップロード

1. 管理画面から「顧客CSV一括取り込み」を選択
2. `.xlsx` または `.xls` ファイルを選択（最大10MB）
3. 「Excelファイルをアップロード」ボタンをクリック

**対応ファイル形式:**
- Microsoft Excel 2007以降 (`.xlsx`)
- Microsoft Excel 97-2003 (`.xls`)

---

### Step 2: シート選択

1. ファイル内のシート一覧が表示されます
2. ドロップダウンから目的のシートを選択
   - 各シートの行数・列数も表示されます
3. 選択すると自動的にデータプレビューが表示されます

**例:**
```
受注シート2025年11月 - 1日.xlsx
  ├─ 1日 (150行 × 20列)
  ├─ 2日 (142行 × 20列)
  └─ 集計 (10行 × 5列)
```

---

### Step 3: カラムマッピング

#### 3-1. 行範囲の指定

- **開始行**: データが始まる行番号（通常は2行目 = ヘッダーの次）
- **終了行**: データが終わる行番号（空欄 = 最終行まで）

**例:**
```
開始行: 2    （1行目はヘッダーなので2行目から）
終了行: (空)  （最後まで読み込む）
```

#### 3-2. 列の指定

各項目に対応する列を選択します：

| 項目 | 必須 | 説明 |
|------|------|------|
| **電話番号** | ✅ 必須 | 顧客を識別するための主キー |
| 顧客名 | 任意 | 顧客の名前 |
| メールアドレス | 任意 | 連絡先メール |
| 住所 | 任意 | 自宅住所 |
| 備考 | 任意 | メモや特記事項 |
| 生年月日 | 任意 | 生年月日 |
| 顧客タイプ | 任意 | new/regular/vip等 |
| 交通費 | 任意 | 自宅交通費 |

**重要:** 電話番号列は必ず指定してください。その他は任意です。

---

### Step 4: データ確認＆インポート

#### 4-1. プレビュー表示

- 解析されたデータが一覧表示されます
- 新規顧客は **緑色**、既存顧客（更新）は **黄色** で表示
- 統計情報も表示されます：
  - 合計件数
  - 新規登録件数
  - 更新件数

#### 4-2. 一括インポート実行

1. データを確認
2. 「〇〇件の顧客データを一括インポート」ボタンをクリック
3. 確認ダイアログで「OK」
4. インポート結果が表示されます

**インポート結果の例:**
```
✅ インポート完了！
新規登録: 45件
更新: 23件
失敗: 0件
```

---

## 🔧 技術仕様

### 電話番号の自動正規化

多様な形式の電話番号を自動的に統一形式に変換します：

| 入力形式 | 正規化後 |
|---------|---------|
| `090-1234-5678` | `09012345678` |
| `090 1234 5678` | `09012345678` |
| `(090) 1234-5678` | `09012345678` |
| `+81-90-1234-5678` | `09012345678` |
| `81-90-1234-5678` | `09012345678` |

### 重複検出ロジック

1. 電話番号を正規化
2. データベース内の既存顧客と照合
3. 一致した場合:
   - 既存顧客として扱う
   - 指定された情報を更新
   - 受注履歴は保持
4. 一致しない場合:
   - 新規顧客として登録

### データベーストランザクション

- 全件成功 or 全件ロールバック
- インポート途中でエラーが発生しても安全
- データの整合性を保証

---

## 📋 実際の使用例

### ケース1: 11月の受注データから顧客情報を抽出

**Excelファイル:** `受注シート2025年11月 - 1日.xlsx`

1. ファイルアップロード
2. シート選択: **「1日」**
3. 行範囲: 開始行 `2`, 終了行 `空`
4. カラムマッピング:
   - 電話番号: **列3** (C列)
   - 顧客名: **列4** (D列)
   - 住所: **列7** (G列)
5. データプレビューで確認
6. インポート実行

**結果:**
- 新規顧客: 15名
- 既存顧客更新: 32名
- 合計: 47名

---

### ケース2: 顧客リストの一括更新

**Excelファイル:** `顧客マスター_20251201.xlsx`

1. ファイルアップロード
2. シート選択: **「顧客一覧」**
3. 行範囲: 開始行 `2`, 終了行 `空`
4. カラムマッピング:
   - 電話番号: **列1** (A列)
   - 顧客名: **列2** (B列)
   - メール: **列3** (C列)
   - 住所: **列4** (D列)
   - 備考: **列5** (E列)
5. インポート実行

**結果:**
- 全150名の顧客情報を一括更新

---

## 🔍 電話番号検索機能

インポート画面の下部にある「電話番号検索」セクションで、既存顧客を検索できます。

### 使い方

1. 電話番号を入力（例: `090-1234-5678`）
2. 「検索」ボタンをクリック
3. 結果が表示されます：
   - 顧客情報（名前、メール、住所など）
   - 受注履歴（最新10件）

### 活用シーン

- インポート前に既存顧客かどうか確認
- 顧客の受注履歴を確認
- 重複登録の防止

---

## ⚠️ 注意事項

### ファイルサイズ

- 最大ファイルサイズ: **10MB**
- 推奨: 1ファイルあたり5,000行以内

### データ形式

1. **電話番号は必須**
   - 電話番号がない行はスキップされます
2. **ヘッダー行は必須**
   - 1行目はヘッダー（列名）として扱われます
3. **空行は自動でスキップ**
   - データがない行は無視されます

### パフォーマンス

- 大量データ（1,000件以上）の場合、処理に1-2分かかることがあります
- インポート中は画面を閉じないでください

---

## 🆚 CSV vs Excel の比較

| 項目 | CSV | Excel |
|------|-----|-------|
| **シート選択** | ❌ 不可 | ✅ 可能 |
| **カラムマッピング** | ❌ 固定 | ✅ 自由 |
| **行範囲指定** | ❌ 不可 | ✅ 可能 |
| **複雑なデータ** | ❌ 難しい | ✅ 対応 |
| **シンプルなデータ** | ✅ 推奨 | ⚠️ オーバースペック |

### 使い分けのポイント

**CSVを選ぶ場合:**
- 既にCSV形式でデータがある
- シンプルな顧客リスト
- 列の順序が決まっている

**Excelを選ぶ場合:**
- 受注シートなど複雑なファイル
- 複数シートがある
- 列の順序が不規則
- 特定の行範囲だけ取り込みたい

---

## 🛠️ トラブルシューティング

### Q1: 「電話番号列を必ず指定してください」と表示される

**A:** カラムマッピングで「電話番号」列を選択していません。電話番号は必須項目です。

---

### Q2: インポート後、一部の顧客が登録されていない

**A:** 以下を確認してください：
- 電話番号が空欄ではないか
- 行範囲指定が正しいか
- インポート結果の「失敗」件数を確認

---

### Q3: 既存顧客の情報が上書きされてしまった

**A:** これは正常な動作です。既存顧客の場合、新しい情報で更新されます。
- 更新したくない項目は、列を選択しないでください

---

### Q4: 大量データのインポートが遅い

**A:** 以下を試してください：
1. ファイルを分割（例: 1,000件ごと）
2. 不要な列を削除
3. 時間帯をずらす（深夜など）

---

## 📚 関連ドキュメント

- [顧客CSV一括取り込みガイド](./CUSTOMER_IMPORT_GUIDE.md)
- [顧客管理システム概要](./docs/customer-management.md)
- [APIドキュメント](./docs/api-documentation.md)

---

## 💡 今後の拡張予定

### Phase 2（2週間以内）
- [ ] Google Sheets直接連携
- [ ] 自動定期インポート（毎日自動実行）
- [ ] エラー行の個別修正機能

### Phase 3（1ヶ月以内）
- [ ] インポート履歴の管理
- [ ] カラムマッピングのテンプレート保存
- [ ] バッチインポートのスケジュール機能

---

## 📞 サポート

質問や問題がある場合は、開発チームまでお問い合わせください。

**作成日:** 2025-12-16  
**最終更新:** 2025-12-16  
**バージョン:** 1.0.0
